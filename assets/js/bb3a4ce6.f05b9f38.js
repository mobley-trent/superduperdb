"use strict";(self.webpackChunknewdocs=self.webpackChunknewdocs||[]).push([[3594],{85212:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>i,default:()=>p,frontMatter:()=>s,metadata:()=>c,toc:()=>l});var o=t(85893),r=t(11151);const s={sidebar_position:28},i="Creating complex stacks of functionality",c={id:"docs/walkthrough/creating_stacks_of_functionality",title:"Creating complex stacks of functionality",description:"With the declarative API, it's possible to create multiple",source:"@site/content/docs/walkthrough/creating_stacks_of_functionality.md",sourceDirName:"docs/walkthrough",slug:"/docs/walkthrough/creating_stacks_of_functionality",permalink:"/docs/docs/walkthrough/creating_stacks_of_functionality",draft:!1,unlisted:!1,editUrl:"https://github.com/SuperDuperDB/superduperdb/blob/main/docs/hr/content/docs/walkthrough/creating_stacks_of_functionality.md",tags:[],version:"current",sidebarPosition:28,frontMatter:{sidebar_position:28},sidebar:"tutorialSidebar",previous:{title:"Serializing components with SuperDuperDB",permalink:"/docs/docs/walkthrough/serialization"},next:{title:"Developer vs. production mode",permalink:"/docs/docs/production/developer_vs_production_mode"}},a={},l=[];function d(e){const n={code:"code",em:"em",h1:"h1",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,r.a)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.h1,{id:"creating-complex-stacks-of-functionality",children:"Creating complex stacks of functionality"}),"\n",(0,o.jsx)(n.p,{children:"With the declarative API, it's possible to create multiple\ncomponents, models and workflows with a single declaration\nof the outcome."}),"\n",(0,o.jsxs)(n.p,{children:["Here is an example in which vectors are prepared using a\nconvolutional neural network over images,\nand these vectors are used downstream in ",(0,o.jsx)(n.em,{children:(0,o.jsx)(n.strong,{children:"both"})}),"\nvector-search and in a transfer-learning task."]}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:["The ",(0,o.jsx)(n.code,{children:"Listener"})," instance, wraps the CNN ",(0,o.jsx)(n.code,{children:"'my-cnn-vectorizer'"}),",\nwhich contains the ",(0,o.jsx)(n.code,{children:"torch"})," layer and pre-processing/ post-processing."]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:["The ",(0,o.jsx)(n.code,{children:"Stack"})," reuses this ",(0,o.jsx)(n.code,{children:"Listener"})," twice, once in the ",(0,o.jsx)(n.code,{children:"VectorIndex"}),",\nwhich may be used to find images, using images,\nand once with the support-vector-machine ",(0,o.jsx)(n.code,{children:"SVC()"}),", which ingests\nthe vectors calculated by the ",(0,o.jsx)(n.code,{children:"Listener"}),", and, is fitted\nbased on those vectors and the label set."]}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:"from sklearn.svm import SVC\nfrom my_models.vision import MyTorchModule, prepare_image\n\nfrom superduperdb.ext.numpy import array\nfrom superduperdb.ext.sklearn import Estimator\nfrom superduperdb.ext.torch import TorchModel\nfrom superduperdb import Stack, VectorIndex, Listener\nfrom superduperdb.backends.mongodb import Collection\n\ncollection = Collection('images')\n\nmy_listener=Listener(\n    'my-listener',\n    model=TorchModel(\n        'my-cnn-vectorizer',\n        object=MyTorchModule(),\n        preprocess=prepare_image,\n        postprocess=lambda x: x.numpy(),\n        encoder=array(dtype='float', shape=(512,))\n    )\n    key='img',\n    select=collection.find({'_fold': 'train'})\n)\n\ndb.add(\n    Stack(\n        'my-stack',\n        [\n            my_listener,\n            VectorIndex(\n                'my-index',\n                indexing_listener=my_listener,\n            ),\n            Estimator(\n                'my-classifier',\n                object=SVC()\n                postprocess=lambda x: ['apples', 'pears'][x]\n                train_select=my_listener.outputs,\n                train_X='img',\n                train_y='labels',\n            )\n        ],\n    )\n)\n"})})]})}function p(e={}){const{wrapper:n}={...(0,r.a)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},11151:(e,n,t)=>{t.d(n,{Z:()=>c,a:()=>i});var o=t(67294);const r={},s=o.createContext(r);function i(e){const n=o.useContext(s);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),o.createElement(s.Provider,{value:n},e.children)}}}]);